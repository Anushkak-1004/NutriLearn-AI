version: '3.8'

services:
  # Frontend Service - React + Vite Development Server
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: nutrilearn-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules  # Anonymous volume for node_modules to prevent overwriting
    environment:
      - VITE_API_BASE_URL=http://localhost:8000/api/v1
    depends_on:
      - backend
    networks:
      - nutrilearn-network
    command: npm run dev -- --host 0.0.0.0
    restart: unless-stopped

  # Backend Service - FastAPI Application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nutrilearn-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./ml-models:/ml-models  # Mount ML models directory
    environment:
      - DATABASE_URL=postgresql://nutrilearn:nutrilearn@database:5432/nutrilearn
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_KEY=${SUPABASE_KEY:-}
      - MLFLOW_TRACKING_URI=http://localhost:5000
      - MODEL_PATH=/ml-models/food_classifier.pth
    depends_on:
      database:
        condition: service_healthy
    networks:
      - nutrilearn-network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # Database Service - PostgreSQL
  database:
    image: postgres:15-alpine
    container_name: nutrilearn-database
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=nutrilearn
      - POSTGRES_PASSWORD=nutrilearn
      - POSTGRES_DB=nutrilearn
    volumes:
      - postgres-data:/var/lib/postgresql/data  # Persistent volume for database
    networks:
      - nutrilearn-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nutrilearn"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# Named volumes for persistent data
volumes:
  postgres-data:
    driver: local

# Custom network for service communication
networks:
  nutrilearn-network:
    driver: bridge
